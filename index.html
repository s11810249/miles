<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>哩程管家</title>
    
    <link rel="apple-touch-icon" href="files/icon.png">
    <link rel="icon" type="image/svg+xml" href="files/icon.svg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="哩程管家">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', '"Helvetica Neue"', 'Arial', 'sans-serif'],
                        serif: ['"Times New Roman"', 'Times', 'serif'],
                        mono: ['"Courier New"', 'Courier', 'monospace'],
                        farrington: ['"Share Tech Mono"', 'monospace'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'zoom-in': 'zoomIn 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        zoomIn: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        html { scroll-behavior: smooth; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .font-credit-card {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
            letter-spacing: 0.15em;
        }
        /* Custom scrollbar for textareas */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="bg-[#f8f9fa] text-slate-800 antialiased selection:bg-blue-100 selection:text-blue-900">
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { Plus, Trash2, Wallet, TrendingUp, Plane, Award, User, X, Settings, Calendar, Clock, ArrowDownCircle, Edit3, Check, ChevronLeft, History, CreditCard, Hash, AlertTriangle, CheckCircle2, CalendarDays, LogOut, ShieldCheck, Cloud, CloudOff, PlusCircle, CalendarOff, RefreshCw, Zap, ArrowUpDown, ArrowUp, ArrowDown, MoveUp, MoveDown, List, ChevronDown, Wrench, Save } from 'https://esm.sh/lucide-react@0.294.0';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBScPpOz_ovEEIffl7S382MJKdq37L3pQA",
            authDomain: "chang-miles.firebaseapp.com",
            projectId: "chang-miles",
            storageBucket: "chang-miles.firebasestorage.app",
            messagingSenderId: "285232593870",
            appId: "1:285232593870:web:6bce1932eb953b22fe499f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'miletracker-release-v1'; 

        // --- Assets ---
        const LogoFiles = { ci: 'files/CI_logo.svg', br: 'files/BR_logo.svg', jx: 'files/JX_logo.svg', nh: 'files/NH_logo.svg', jl: 'files/JL_logo.svg', cx: 'files/CX_logo.svg', as: 'files/AS_logo.svg' };
        const AllianceFiles = { star: 'files/StarAlliance_logo.jpeg', skyteam: 'files/skyteam_logo.png', oneworld: 'files/Oneworld_logo.png' };
        
        const SvgLogos = {
            ci: React.createElement("svg", {viewBox:"0 0 100 100", className:"w-full h-full fill-current"}, React.createElement("path", {d:"M50 20 C60 20 70 30 70 45 C70 60 60 70 50 85 C40 70 30 60 30 45 C30 30 40 20 50 20 Z", fillOpacity:"0.9"}), React.createElement("path", {d:"M50 25 C55 25 60 30 60 40 C60 50 55 55 50 65 C45 55 40 50 40 40 C40 30 45 25 50 25 Z", fill:"white"})),
            default: React.createElement("svg", {viewBox:"0 0 100 100", className:"w-full h-full fill-current"}, React.createElement("circle", {cx:"50", cy:"50", r:"40", fillOpacity:"0.2"}))
        };

        const AllianceSvgs = {
            star: React.createElement("svg", {viewBox:"0 0 100 20", className:"w-full h-full fill-white/90"}, React.createElement("text", {x:"55", y:"15", fontSize:"10", textAnchor:"middle", fontWeight:"bold", className:"fill-white"}, "STAR ALLIANCE")),
            skyteam: React.createElement("svg", {viewBox:"0 0 100 20", className:"w-full h-full fill-white/90"}, React.createElement("text", {x:"80", y:"15", fontSize:"10", textAnchor:"end", fontWeight:"bold", className:"fill-white"}, "SKYTEAM")),
            oneworld: React.createElement("svg", {viewBox:"0 0 100 20", className:"w-full h-full fill-white/90"}, React.createElement("text", {x:"35", y:"15", fontSize:"10", fontWeight:"bold", className:"fill-white"}, "oneworld"))
        };

        // --- Helpers ---
        const getTaiwanDate = () => {
            const date = new Date();
            const taiwanDate = new Date(date.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));
            const year = taiwanDate.getFullYear();
            const month = String(taiwanDate.getMonth() + 1).padStart(2, '0');
            const day = String(taiwanDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const formatNumber = (num) => new Intl.NumberFormat('zh-TW').format(num);
        const formatAmountDisplay = (amount) => {
            const num = parseInt(amount);
            if (isNaN(num)) return '0';
            const formatted = formatNumber(Math.abs(num));
            return num > 0 ? `+${formatted}` : `-${formatted}`;
        };
        const formatDateForInput = (date) => date ? new Date(date).toISOString().split('T')[0] : '';
        const formatDateForDisplay = (dateStr) => dateStr ? dateStr.replace(/-/g, '/') : '-';

        const calculateExpiryDate = (transactionDateStr, entryDateStr, rule, allRecords) => {
            // Priority: entryDateStr (入檔日期) > transactionDateStr (入帳日期)
            const dateStr = entryDateStr || transactionDateStr;
            if (!dateStr) return null;
            const [y, m, d] = dateStr.split('-').map(Number);
            let targetY = y;
            let targetM = m - 1; 

            if (rule.type === 'activity') {
                const timestamps = allRecords.map(r => {
                    // For activity-based expiry, use the latest entry/transaction date from all records for calculation
                    const calcDateStr = r.entryDate || r.date;
                    if (!calcDateStr) return NaN;
                    const [ry, rm, rd] = calcDateStr.split('-').map(Number);
                    return new Date(ry, rm - 1, rd).getTime();
                }).filter(t => !isNaN(t));
                if (timestamps.length > 0) {
                    const maxDate = new Date(Math.max(...timestamps));
                    targetY = maxDate.getFullYear();
                    targetM = maxDate.getMonth();
                }
            } else if (rule.type !== 'fixed') {
                return null;
            }

            if (rule.unit === 'year') targetY += parseInt(rule.value);
            else targetM += parseInt(rule.value);
            return new Date(targetY, targetM + 1, 0, 12, 0, 0);
        };

        const calculateExpiryDisplay = (transactionDateStr, entryDateStr, rule, allRecords, amount) => {
            if (parseInt(amount) <= 0) return { text: null, color: '' };
            if (rule.type === 'none') return { text: '終身有效', color: 'text-green-600 bg-green-50' };
            const expiryDate = calculateExpiryDate(transactionDateStr, entryDateStr, rule, allRecords);
            if (!expiryDate) return { text: '-', color: 'text-gray-400 bg-gray-50' };
            const today = new Date();
            const diffTime = expiryDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const year = expiryDate.getFullYear();
            const month = String(expiryDate.getMonth() + 1).padStart(2, '0');
            const day = String(expiryDate.getDate()).padStart(2, '0');
            const dateString = `${year}/${month}/${day}`;
            if (diffDays < 0) return { text: `${dateString} (已過期)`, color: 'text-red-600 bg-red-50 font-bold' };
            if (diffDays < 90) return { text: `${dateString} (剩 ${diffDays} 天)`, color: 'text-red-500 bg-red-50' };
            return { text: dateString, color: 'text-gray-500 bg-gray-50' };
        };

        // --- Default Templates (Fallback) ---
        const DEFAULT_TEMPLATES = [
            { id: 'ci', code: 'CI', name: '中華航空', enName: 'China Airlines', alliance: 'skyteam', program: '華夏會員', tier: '金卡', memberId: '', tierOptions: ['華夏會員', '金卡', '翡翠卡', '晶鑽卡'], cardClass: 'bg-gradient-to-br from-[#4a1050] to-[#862562] text-white', logoColor: 'text-purple-900', expiryRule: { type: 'activity', value: 36, unit: 'month' }, 
            categoryOptions: ['信用卡轉換', '飛行', '活動', '雜項'], 
            categoryColors: { '信用卡轉換': 'bg-blue-100 text-blue-800', '飛行': 'bg-green-100 text-green-800', '活動': 'bg-purple-100 text-purple-800', '雜項': 'bg-gray-100 text-gray-800' },
            records: [], pending: [] },
            { id: 'br', code: 'BR', name: '長榮航空', enName: 'EVA Air', alliance: 'star', program: '無限萬哩遊', tier: '銀卡', memberId: '', tierOptions: ['綠卡', '銀卡', '金卡', '鑽石卡'], cardClass: 'bg-gradient-to-br from-[#005230] to-[#00824b] text-white', logoColor: 'text-green-800', expiryRule: { type: 'fixed', value: 36, unit: 'month' }, 
            categoryOptions: ['信用卡轉換', '飛行', '活動', '雜項'], 
            categoryColors: { '信用卡轉換': 'bg-blue-100 text-blue-800', '飛行': 'bg-green-100 text-green-800', '活動': 'bg-purple-100 text-purple-800', '雜項': 'bg-gray-100 text-gray-800' },
            records: [], pending: [] },
            { id: 'jx', code: 'JX', name: '星宇航空', enName: 'STARLUX Airlines', alliance: null, program: 'COSMILE', tier: 'Adventurer', memberId: '', tierOptions: ['Traveler', 'Adventurer', 'Explorer', 'Insighter'], cardClass: 'bg-gradient-to-br from-[#59493f] to-[#8c735d] text-white', logoColor: 'text-yellow-700', expiryRule: { type: 'fixed', value: 36, unit: 'month' }, 
            categoryOptions: ['信用卡轉換', '飛行', '活動', '雜項'], 
            categoryColors: { '信用卡轉換': 'bg-blue-100 text-blue-800', '飛行': 'bg-green-100 text-green-800', '活動': 'bg-purple-100 text-purple-800', '雜項': 'bg-gray-100 text-gray-800' },
            records: [], pending: [] },
            { id: 'nh', code: 'NH', name: 'ANA全日空', enName: 'All Nippon Airways', alliance: 'star', program: 'Mileage Club', tier: 'Platinum', memberId: '', tierOptions: ['一般會員', 'Bronze', 'Platinum', 'Diamond'], cardClass: 'bg-gradient-to-br from-[#003d7c] to-[#007cc2] text-white', logoColor: 'text-blue-800', expiryRule: { type: 'fixed', value: 36, unit: 'month' }, 
            categoryOptions: ['信用卡轉換', '飛行', '活動', '雜項'], 
            categoryColors: { '信用卡轉換': 'bg-blue-100 text-blue-800', '飛行': 'bg-green-100 text-green-800', '活動': 'bg-purple-100 text-purple-800', '雜項': 'bg-gray-100 text-gray-800' },
            records: [], pending: [] },
            { id: 'jl', code: 'JL', name: '日本航空', enName: 'Japan Airlines', alliance: 'oneworld', program: 'JAL Mileage Bank', tier: 'Crystal', memberId: '', tierOptions: ['普通會員', 'Crystal', 'Sapphire', 'Diamond', 'JGC Premier'], cardClass: 'bg-gradient-to-br from-[#8a0000] to-[#d60000] text-white', logoColor: 'text-red-800', expiryRule: { type: 'fixed', value: 36, unit: 'month' }, 
            categoryOptions: ['信用卡轉換', '飛行', '活動', '雜項'], 
            categoryColors: { '信用卡轉換': 'bg-blue-100 text-blue-800', '飛行': 'bg-green-100 text-green-800', '活動': 'bg-purple-100 text-purple-800', '雜項': 'bg-gray-100 text-gray-800' },
            records: [], pending: [] },
            { id: 'cx', code: 'CX', name: '國泰航空', enName: 'Cathay Pacific', alliance: 'oneworld', program: '亞洲萬里通', tier: 'Green', memberId: '', tierOptions: ['Green', 'Silver', 'Gold', 'Diamond'], cardClass: 'bg-gradient-to-br from-[#004e4e] to-[#007a7a] text-white', logoColor: 'text-teal-800', expiryRule: { type: 'activity', value: 18, unit: 'month' }, 
            categoryOptions: ['信用卡轉換', '飛行', '活動', '雜項'], 
            categoryColors: { '信用卡轉換': 'bg-blue-100 text-blue-800', '飛行': 'bg-green-100 text-green-800', '活動': 'bg-purple-100 text-purple-800', '雜項': 'bg-gray-100 text-gray-800' },
            records: [], pending: [] },
            { id: 'as', code: 'AS', name: '阿拉斯加航空', enName: 'Alaska Airlines', alliance: 'oneworld', program: 'Mileage Plan', tier: 'MVP', memberId: '', tierOptions: ['MVP', 'MVP Gold', 'MVP Gold 75K', 'MVP Gold 100K'], cardClass: 'bg-gradient-to-br from-[#00385d] to-[#001f3f] text-white', logoColor: 'text-white', expiryRule: { type: 'activity', value: 24, unit: 'month' }, 
            categoryOptions: ['信用卡轉換', '飛行', '活動', '雜項'], 
            categoryColors: { '信用卡轉換': 'bg-blue-100 text-blue-800', '飛行': 'bg-green-100 text-green-800', '活動': 'bg-purple-100 text-purple-800', '雜項': 'bg-gray-100 text-gray-800' },
            records: [], pending: [] }
        ];

        // --- Custom Components ---
        const CustomSelect = ({ value, options, onChange }) => {
            const [isOpen, setIsOpen] = useState(false);
            const ref = useRef(null);
            useEffect(() => {
                const handleClickOutside = (event) => { if (ref.current && !ref.current.contains(event.target)) setIsOpen(false); };
                document.addEventListener('mousedown', handleClickOutside); return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);
            return React.createElement("div", { ref: ref, className: "relative w-full" },
                React.createElement("button", { onClick: () => setIsOpen(!isOpen), className: "w-full flex items-center justify-between bg-slate-50 border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-semibold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none transition-shadow" }, value || "請選擇", React.createElement(ChevronDown, { size: 16, className: `text-slate-400 transition-transform ${isOpen ? 'rotate-180' : ''}` })),
                isOpen && React.createElement("div", { className: "absolute z-50 w-full mt-1 bg-white border border-gray-100 rounded-xl shadow-xl max-h-48 overflow-y-auto no-scrollbar animate-in zoom-in-95 duration-200" }, options.map((opt) => React.createElement("button", { key: opt, onClick: () => { onChange(opt); setIsOpen(false); }, className: `w-full text-left px-4 py-2.5 text-sm hover:bg-slate-50 transition-colors ${value === opt ? 'font-bold text-blue-600 bg-blue-50' : 'text-slate-600'}` }, opt)))
            );
        };

        const AirlineLogo = ({ id, colorClass }) => {
            const [imgError, setImgError] = useState(false);
            const logoKey = id ? id.split('_')[0] : '';
            return React.createElement("div", {className: "w-11 h-11 bg-white rounded-full p-2 shadow-sm flex items-center justify-center overflow-hidden"}, 
                imgError ? (SvgLogos[logoKey] || SvgLogos['default']) : React.createElement("img", { src: LogoFiles[logoKey] || LogoFiles[id], alt: id, className: "w-full h-full object-contain", onError: () => setImgError(true) })
            );
        };

        const AllianceLogo = ({ id }) => {
            const [imgError, setImgError] = useState(false);
            if (!id) return null;
            return React.createElement("div", {className: "w-32 h-10 mb-1 flex items-center justify-end"}, 
                imgError ? AllianceSvgs[id] : React.createElement("img", { src: AllianceFiles[id], onError: () => setImgError(true), alt: id, className: "h-full w-auto object-contain opacity-90" })
            );
        };

        // --- Admin Template Editor Modal ---
        const AdminTemplateModal = ({ isOpen, onClose, templates, onSave }) => {
            const [editingTemplates, setEditingTemplates] = useState(templates);
            const [selectedIndex, setSelectedIndex] = useState(0);
            
            // Local state for free typing
            const [rawCategories, setRawCategories] = useState('');
            const [rawColors, setRawColors] = useState('');

            useEffect(() => { 
                setEditingTemplates(templates); 
            }, [templates]);
            
            // Sync local raw strings when selected template changes
            useEffect(() => {
                if (editingTemplates[selectedIndex]) {
                    const current = editingTemplates[selectedIndex];
                    setRawCategories((current.categoryOptions || []).join(', '));
                    setRawColors(Object.entries(current.categoryColors || {}).map(([key, value]) => `${key}=${value}`).join('\n'));
                }
            }, [selectedIndex, editingTemplates]);

            if (!isOpen) return null;

            const current = editingTemplates[selectedIndex];

            const handleChange = (field, value) => {
                const newTemplates = [...editingTemplates];
                newTemplates[selectedIndex] = { ...current, [field]: value };
                setEditingTemplates(newTemplates);
            };

            const handleTierChange = (val) => {
                const tiers = val.split(',').map(t => t.trim());
                handleChange('tierOptions', tiers);
            };
            
            // Update local state and sync to main state structure (without breaking typing)
            const handleRawCategoryChange = (val) => {
                setRawCategories(val);
                const categories = val.split(',').map(t => t.trim()).filter(t => t);
                handleChange('categoryOptions', categories);
            };

            const handleRawColorChange = (val) => {
                setRawColors(val);
                const newColors = {};
                val.split('\n').forEach(line => {
                    const [key, value] = line.split('=');
                    if (key && value) newColors[key.trim()] = value.trim();
                });
                handleChange('categoryColors', newColors);
            };

            const handleAdd = () => {
                const newId = prompt("請輸入新航空 ID (例如: ua)");
                if(newId) {
                    setEditingTemplates(prev => [...prev, {
                         id: newId, code: newId.toUpperCase(), name: '新航空', enName: 'New Airline', alliance: null, program: 'Program', tier: 'Member', tierOptions: ['Member'], cardClass: 'bg-slate-700 text-white', logoColor: 'text-white', expiryRule: {type: 'fixed', value: 36, unit: 'month'}, 
                         categoryOptions: ['信用卡轉換', '飛行'], 
                         categoryColors: { '信用卡轉換': 'bg-blue-100 text-blue-800', '飛行': 'bg-green-100 text-green-800' },
                         records: [], pending: []
                    }]);
                    setSelectedIndex(editingTemplates.length); // State update is async, but for simplicity here
                }
            };

            const handleDelete = () => {
                if(confirm("確定刪除此模板？")) {
                    const newT = editingTemplates.filter((_, i) => i !== selectedIndex);
                    setEditingTemplates(newT);
                    setSelectedIndex(0);
                }
            };

            return React.createElement("div", {className: "fixed inset-0 z-[110] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4"},
                React.createElement("div", {className: "bg-white w-full max-w-4xl h-[90vh] rounded-3xl flex overflow-hidden shadow-2xl"},
                    // Sidebar
                    React.createElement("div", {className: "w-1/3 bg-slate-50 border-r border-slate-100 flex flex-col"},
                        React.createElement("div", {className: "p-4 border-b border-slate-100 font-bold text-slate-700 flex justify-between items-center"}, 
                            "模板列表", 
                            React.createElement("button", {onClick: handleAdd, className: "p-1 bg-blue-100 text-blue-600 rounded hover:bg-blue-200"}, React.createElement(Plus, {size: 16}))
                        ),
                        React.createElement("div", {className: "flex-1 overflow-y-auto p-2 space-y-1"},
                            editingTemplates.map((t, i) => 
                                React.createElement("button", {
                                    key: i,
                                    onClick: () => setSelectedIndex(i),
                                    className: `w-full text-left px-3 py-2 rounded-lg text-sm font-medium ${selectedIndex === i ? 'bg-slate-800 text-white' : 'text-slate-600 hover:bg-slate-100'}`
                                }, `${t.code} - ${t.name}`)
                            )
                        )
                    ),
                    // Editor
                    React.createElement("div", {className: "flex-1 flex flex-col"},
                        React.createElement("div", {className: "p-4 border-b border-slate-100 flex justify-between items-center"},
                            React.createElement("h3", {className: "font-bold text-lg"}, "編輯模板"),
                            React.createElement("button", {onClick: onClose, className: "p-2 hover:bg-slate-100 rounded-full"}, React.createElement(X, {size: 20}))
                        ),
                        React.createElement("div", {className: "flex-1 overflow-y-auto p-6 space-y-4"},
                            current && React.createElement(React.Fragment, null,
                                React.createElement("div", {className: "grid grid-cols-2 gap-4"},
                                    React.createElement("div", null, React.createElement("label", {className:"block text-xs font-bold text-slate-400 mb-1"}, "ID (Logo Key)"), React.createElement("input", {value: current.id, onChange:e=>handleChange('id', e.target.value), className:"w-full border rounded p-2 text-sm"})),
                                    React.createElement("div", null, React.createElement("label", {className:"block text-xs font-bold text-slate-400 mb-1"}, "代碼 (Code)"), React.createElement("input", {value: current.code, onChange:e=>handleChange('code', e.target.value), className:"w-full border rounded p-2 text-sm"}))
                                ),
                                React.createElement("div", null, React.createElement("label", {className:"block text-xs font-bold text-slate-400 mb-1"}, "中文名稱"), React.createElement("input", {value: current.name, onChange:e=>handleChange('name', e.target.value), className:"w-full border rounded p-2 text-sm"})),
                                React.createElement("div", null, React.createElement("label", {className:"block text-xs font-bold text-slate-400 mb-1"}, "英文名稱"), React.createElement("input", {value: current.enName, onChange:e=>handleChange('enName', e.target.value), className:"w-full border rounded p-2 text-sm"})),
                                React.createElement("div", null, React.createElement("label", {className:"block text-xs font-bold text-slate-400 mb-1"}, "計畫名稱"), React.createElement("input", {value: current.program, onChange:e=>handleChange('program', e.target.value), className:"w-full border rounded p-2 text-sm"})),
                                React.createElement("div", null, React.createElement("label", {className:"block text-xs font-bold text-slate-400 mb-1"}, "聯盟 (star/skyteam/oneworld)"), React.createElement("input", {value: current.alliance || '', onChange:e=>handleChange('alliance', e.target.value), className:"w-full border rounded p-2 text-sm"})),
                                React.createElement("div", null, React.createElement("label", {className:"block text-xs font-bold text-slate-400 mb-1"}, "卡片樣式 (Tailwind CSS)"), React.createElement("input", {value: current.cardClass, onChange:e=>handleChange('cardClass', e.target.value), className:"w-full border rounded p-2 text-sm font-mono"})),
                                React.createElement("div", null, React.createElement("label", {className:"block text-xs font-bold text-slate-400 mb-1"}, "會員等級 (逗號分隔)"), React.createElement("textarea", {value: current.tierOptions.join(', '), onChange:e=>handleTierChange(e.target.value), className:"w-full border rounded p-2 text-sm h-20"})),
                                React.createElement("div", {className: "pt-4 border-t border-slate-100"}, 
                                    React.createElement("label", {className:"block text-xs font-bold text-slate-400 mb-1"}, "類別 (逗號分隔)"), 
                                    React.createElement("textarea", {value: rawCategories, onChange: e => handleRawCategoryChange(e.target.value), className:"w-full border rounded p-2 text-sm h-20"})
                                ),
                                React.createElement("div", {className: "pt-4 border-t border-slate-100"},
                                    React.createElement("label", {className:"block text-xs font-bold text-slate-400 mb-1"}, "類別顏色 (Tailwind Class, 每行一組，例如：類別名=顏色)"),
                                    React.createElement("textarea", {
                                        value: rawColors,
                                        onChange: e => handleRawColorChange(e.target.value), 
                                        className:"w-full border rounded p-2 text-sm font-mono h-40"
                                    })
                                ),
                                React.createElement("button", {onClick: handleDelete, className: "text-red-500 text-sm hover:underline"}, "刪除此模板")
                            )
                        ),
                        React.createElement("div", {className: "p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3"},
                            React.createElement("button", {onClick: onClose, className: "px-4 py-2 text-slate-500 font-bold"}, "取消"),
                            React.createElement("button", {onClick: () => onSave(editingTemplates), className: "px-6 py-2 bg-blue-600 text-white rounded-lg font-bold shadow hover:bg-blue-700"}, "儲存全部變更")
                        )
                    )
                )
            );
        };

        const AddAirlineModal = ({ isOpen, onClose, onSelect, templates, isAdmin, onOpenAdmin }) => {
            if (!isOpen) return null;
            
            // Fix: Fallback to DEFAULT_TEMPLATES if templates prop is undefined or not an array
            const displayTemplates = (Array.isArray(templates) && templates.length > 0) ? templates : DEFAULT_TEMPLATES;

            return React.createElement("div", {className: "fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center animate-in fade-in duration-300"},
                React.createElement("div", {className: "absolute inset-0", onClick: onClose}),
                React.createElement("div", {className: "bg-white w-full max-w-md sm:rounded-3xl rounded-t-3xl p-6 shadow-2xl relative z-10 animate-in slide-in-from-bottom-10 duration-300 max-h-[80vh] overflow-y-auto"},
                    React.createElement("div", {className: "flex justify-between items-center mb-6"},
                        React.createElement("h3", {className: "text-xl font-bold text-slate-900"}, "新增會籍卡片"),
                        React.createElement("div", {className: "flex gap-2"},
                            isAdmin && React.createElement("button", {onClick: onOpenAdmin, className: "p-2 bg-yellow-100 text-yellow-700 rounded-full hover:bg-yellow-200"}, React.createElement(Wrench, {size: 16})),
                            React.createElement("button", {onClick: onClose, className: "p-2 bg-gray-100 rounded-full hover:bg-gray-200"}, React.createElement(X, {size: 20}))
                        )
                    ),
                    React.createElement("div", {className: "grid grid-cols-2 gap-4"},
                        displayTemplates.map(template => (
                            React.createElement("button", {
                                key: template.id,
                                onClick: () => onSelect(template),
                                className: "flex flex-col items-center p-4 rounded-xl border border-gray-100 bg-gray-50 hover:bg-white hover:border-blue-200 hover:shadow-md transition-all active:scale-95 text-center group"
                            },
                                React.createElement("div", {className: "w-12 h-12 mb-3 bg-white rounded-full p-2 shadow-sm flex items-center justify-center group-hover:scale-110 transition-transform"}, 
                                    React.createElement("img", {src: LogoFiles[template.id] || LogoFiles[template.id.split('_')[0]] || "", className: "w-full h-full object-contain"})
                                ),
                                React.createElement("span", {className: "text-sm font-bold text-slate-800"}, template.name),
                                React.createElement("span", {className: "text-[10px] text-gray-500 mt-1"}, template.enName)
                            )
                        ))
                    )
                )
            );
        };

        const AirlineCard = ({ airline, onClick, isDetail = false }) => {
            const currentBalance = airline.records.reduce((acc, r) => acc + (parseInt(r.amount)||0), 0);
            
            // Fix: Use h-auto and min-h to allow growth, remove fixed aspect ratio on mobile
            const wrapperClass = isDetail 
                ? "w-full mx-auto shadow-none transition-all duration-500 h-auto min-h-[200px]" 
                : "cursor-pointer shadow-xl shadow-gray-200/50 hover:shadow-2xl hover:shadow-gray-300/40 hover:-translate-y-1 transition-all duration-500 ease-out group h-auto min-h-[200px] md:aspect-[1.586/1]";

            return React.createElement("div", {onClick: onClick, className: `${airline.cardClass} relative rounded-2xl p-6 pb-6 overflow-hidden flex flex-col justify-between ${wrapperClass}`},
                React.createElement("div", {className: `absolute top-0 right-0 -mr-8 -mt-8 w-40 h-40 bg-white opacity-[0.1] rounded-full blur-xl transition-opacity duration-700 ${!isDetail ? 'group-hover:opacity-[0.15]' : ''}`}),
                
                // Top: Logo and Names
                React.createElement("div", {className: "relative z-10 flex justify-between items-start"},
                    React.createElement(AirlineLogo, {id: airline.id, colorClass: airline.logoColor}),
                    React.createElement("div", {className: "text-right"},
                        React.createElement("div", {className: "text-lg font-bold tracking-wide leading-tight text-white drop-shadow-sm"}, airline.name),
                        React.createElement("div", {className: "text-xs font-bold font-sans opacity-80 uppercase tracking-widest mt-0.5"}, airline.enName)
                    )
                ),
                
                // Middle: Accumulated Miles (Moved up with mt-4)
                React.createElement("div", {className: "relative z-10 mt-4 mb-0 pt-0 flex-1 flex flex-col justify-center"},
                    React.createElement("div", {className: "text-[10px] uppercase opacity-70 tracking-widest mb-0 leading-none"}, "累積哩程"),
                    React.createElement("div", {className: "flex items-end justify-between"},
                        React.createElement("span", {className: "text-3xl font-black tracking-tight drop-shadow-md font-sans"}, formatNumber(currentBalance)),
                        React.createElement(AllianceLogo, {id: airline.alliance})
                    )
                ),
                
                // Bottom: Tier and Program with Separator Line
                React.createElement("div", {className: "relative z-10 pt-3 border-t border-white/15 flex justify-between items-end mt-2"}, 
                    React.createElement("div", {className: "flex flex-col gap-1"},
                        React.createElement("div", {className: "inline-flex items-center gap-1.5 px-0 py-1 rounded-md text-sm font-bold tracking-wide text-white/90"},
                            airline.tier
                        )
                    ),
                    React.createElement("div", {className: "text-right max-w-[60%]"},
                        React.createElement("div", {className: "text-lg font-farrington font-bold tracking-widest opacity-95 mb-0.5 font-credit-card"}, airline.memberId || 'NO MEMBER ID'),
                        React.createElement("div", {className: "text-xs opacity-90 truncate"}, airline.program)
                    )
                )
            );
        };
        
        const SplashScreen = ({ onFinish }) => {
            const [width, setWidth] = useState(0);
            const [opacity, setOpacity] = useState(1);
            useEffect(() => {
                let start = null;
                const duration = 2000; 
                const animate = (timestamp) => {
                    if (!start) start = timestamp;
                    const progress = timestamp - start;
                    const percent = Math.min((progress / duration) * 100, 100);
                    setWidth(percent);
                    if (progress < duration) requestAnimationFrame(animate);
                    else setTimeout(() => { setOpacity(0); setTimeout(onFinish, 600); }, 200);
                };
                requestAnimationFrame(animate);
            }, [onFinish]);
            return React.createElement("div", {className: "fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center transition-opacity duration-800 ease-out", style: { opacity, pointerEvents: opacity === 0 ? 'none' : 'auto' }},
                React.createElement("div", {className: "flex flex-col items-center animate-in fade-in zoom-in duration-1000"},
                    React.createElement("div", {className: "relative mb-8"},
                        React.createElement("div", {className: "absolute inset-0 bg-white blur-3xl opacity-20 animate-pulse"}),
                        React.createElement("div", {className: "p-6 border border-white/10 rounded-full bg-white/5 backdrop-blur-md shadow-[0_0_20px_rgba(255,255,255,0.15)]"},
                            React.createElement(Plane, {className: "w-16 h-16 text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]"})
                        )
                    ),
                    React.createElement("h1", {className: "text-4xl font-bold text-white tracking-[0.2em] mb-4 font-serif text-shadow"}, "哩程管家"),
                    React.createElement("p", {className: "text-xs text-gray-500 font-light tracking-[0.5em] uppercase border-t border-white/10 pt-4 mt-2"}, "寰宇萬哩 · 尊榮隨行")
                ),
                React.createElement("div", {className: "absolute bottom-24 w-64 h-1 bg-gray-900 rounded-full overflow-hidden"},
                    React.createElement("div", {className: "h-full bg-white rounded-full shadow-[0_0_15px_rgba(255,255,255,0.9)]", style: { width: `${width}%` }})
                )
            );
        };

        const Toast = ({ message, type, isVisible }) => (
            React.createElement("div", {className: `fixed top-6 left-1/2 -translate-x-1/2 z-[120] flex items-center gap-2 px-4 py-3 rounded-full shadow-2xl transition-all duration-500 cubic-bezier(0.175, 0.885, 0.32, 1.275) ${isVisible ? 'translate-y-0 opacity-100' : '-translate-y-20 opacity-0 pointer-events-none'} ${type === 'success' ? 'bg-slate-900 text-white' : 'bg-red-500 text-white'}`},
                type === 'success' ? React.createElement(CheckCircle2, {size: 18, className: "text-green-400"}) : React.createElement(AlertTriangle, {size: 18, className: "text-white"}),
                React.createElement("span", {className: "text-sm font-bold tracking-wide"}, message)
            )
        );

        const ConfirmDialog = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "確認刪除", confirmColorClass = "bg-red-500 hover:bg-red-600 shadow-red-200" }) => {
            const [show, setShow] = useState(isOpen);
            const [isClosing, setIsClosing] = useState(false);
            useEffect(() => { if (isOpen) { setShow(true); setIsClosing(false); } else { setIsClosing(true); setTimeout(() => setShow(false), 300); } }, [isOpen]);
            if (!show) return null;
            return React.createElement("div", {className: `fixed inset-0 z-[110] flex items-center justify-center px-4 transition-opacity duration-300 ${isClosing ? 'opacity-0' : 'opacity-100'}`},
                React.createElement("div", {className: "absolute inset-0 bg-black/40 backdrop-blur-sm", onClick: onCancel}),
                React.createElement("div", {className: `bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl relative z-10 transition-all duration-300 transform ${isClosing ? 'scale-95 translate-y-4' : 'scale-100 translate-y-0'}`},
                    React.createElement("div", {className: "flex flex-col items-center text-center mb-6"},
                        React.createElement("div", {className: "w-12 h-12 bg-gray-50 rounded-full flex items-center justify-center mb-4 text-gray-500"}, React.createElement(AlertTriangle, {size: 24})),
                        React.createElement("h3", {className: "text-lg font-bold text-slate-900 mb-2"}, title),
                        React.createElement("p", {className: "text-sm text-slate-500 leading-relaxed"}, message)
                    ),
                    React.createElement("div", {className: "grid grid-cols-2 gap-3"},
                        React.createElement("button", {onClick: onCancel, className: "py-3 rounded-xl font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 transition-colors"}, "取消"),
                        React.createElement("button", {onClick: onConfirm, className: `py-3 rounded-xl font-bold text-white shadow-lg transition-colors ${confirmColorClass}`}, confirmText)
                    )
                )
            );
        };

        const ReorderModal = ({ isOpen, onClose, items, onMove }) => {
            if (!isOpen) return null;
            return React.createElement("div", {className: "fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center animate-in fade-in duration-300 p-4"},
                React.createElement("div", {className: "absolute inset-0", onClick: onClose}),
                React.createElement("div", {className: "bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative z-10 animate-in zoom-in-95 duration-300 max-h-[80vh] flex flex-col"},
                    React.createElement("div", {className: "flex justify-between items-center mb-4"},
                        React.createElement("h3", {className: "text-xl font-bold text-slate-900"}, "排序卡片"),
                        React.createElement("button", {onClick: onClose, className: "p-2 bg-gray-100 rounded-full hover:bg-gray-200"}, React.createElement(X, {size: 20}))
                    ),
                    React.createElement("div", {className: "flex-1 overflow-y-auto space-y-3 pr-2"},
                        items.map((item, index) => (
                            React.createElement("div", {key: item.id, className: "flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-gray-100"},
                                React.createElement("div", {className: "flex items-center gap-3"},
                                    React.createElement("div", {className: "w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center p-1.5"}, 
                                        React.createElement("img", {src: LogoFiles[item.id.split('_')[0]] || "", className: "w-full h-full object-contain"})
                                    ),
                                    React.createElement("span", {className: "font-bold text-slate-700 text-sm"}, item.name)
                                ),
                                React.createElement("div", {className: "flex gap-1"},
                                    React.createElement("button", {
                                        onClick: () => onMove(index, -1),
                                        disabled: index === 0,
                                        className: `p-2 rounded-lg ${index === 0 ? 'text-slate-200' : 'text-slate-500 hover:bg-white hover:shadow-sm'}`
                                    }, React.createElement(ArrowUp, {size: 16})),
                                    React.createElement("button", {
                                        onClick: () => onMove(index, 1),
                                        disabled: index === items.length - 1,
                                        className: `p-2 rounded-lg ${index === items.length - 1 ? 'text-slate-200' : 'text-slate-500 hover:bg-white hover:shadow-sm'}`
                                    }, React.createElement(ArrowDown, {size: 16}))
                                )
                            )
                        ))
                    ),
                    React.createElement("button", {onClick: onClose, className: "mt-4 w-full bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-slate-800 transition-colors"}, "完成")
                )
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [loading, setLoading] = useState(false);
            const handleGoogleLogin = async () => {
                if (!auth) { alert("Firebase 設定未完成"); return; }
                setLoading(true);
                const provider = new GoogleAuthProvider();
                try { await signInWithPopup(auth, provider); } 
                catch (error) { console.error("Error", error); alert("登入失敗"); setLoading(false); }
            };
            return React.createElement("div", {className: "fixed inset-0 bg-[#f8f9fa] flex items-center justify-center p-6 animate-in fade-in zoom-in duration-500"},
                React.createElement("div", {className: "w-full max-w-sm bg-white rounded-3xl p-8 shadow-2xl text-center border border-gray-100"},
                    React.createElement("div", {className: "flex justify-center mb-6"},
                        React.createElement("div", {className: "p-5 bg-slate-900 rounded-full shadow-lg shadow-slate-200"}, React.createElement(Plane, {className: "w-10 h-10 text-white"}))
                    ),
                    React.createElement("h1", {className: "text-2xl font-bold text-slate-900 mb-2 font-serif tracking-wide"}, "哩程管家"),
                    React.createElement("p", {className: "text-sm text-slate-400 mb-8 tracking-widest uppercase"}, "Premium Mileage Tracker"),
                    React.createElement("button", {onClick: handleGoogleLogin, disabled: loading, className: "w-full flex items-center justify-center gap-3 bg-white border border-gray-200 hover:bg-gray-50 text-slate-700 font-bold py-3.5 rounded-xl transition-all shadow-sm active:scale-95"}, "使用 Google 帳號登入"),
                    React.createElement("div", {className: "mt-8 flex items-center justify-center gap-2 text-xs text-gray-400"}, React.createElement(ShieldCheck, {size: 14}), React.createElement("span", null, "資料安全加密儲存"))
                )
            );
        };

        const MainApp = ({ user, onLogout }) => {
            const [airlines, setAirlines] = useState([]); 
            const [selectedAirlineId, setSelectedAirlineId] = useState(null);
            const [isDataLoaded, setIsDataLoaded] = useState(false); 
            
            // Admin State
            const [isAdmin, setIsAdmin] = useState(false);
            const [airlineTemplates, setAirlineTemplates] = useState(DEFAULT_TEMPLATES);
            const [isAdminModalOpen, setIsAdminModalOpen] = useState(false);

            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isAddAirlineOpen, setIsAddAirlineOpen] = useState(false);
            const [isReorderOpen, setIsReorderOpen] = useState(false); 
            
            const [editorState, setEditorState] = useState({ isOpen: false, type: null, data: null }); 
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, item: null, date: '' });
            const [toast, setToast] = useState({ message: '', type: '', isVisible: false });
            const [confirmDialog, setConfirmDialog] = useState({ isOpen: false, title: '', message: '', onConfirm: null, confirmText: '確認刪除', confirmColorClass: 'bg-red-500' });
            
            const [isDetailClosing, setIsDetailClosing] = useState(false);
            const [isSettingsClosing, setIsSettingsClosing] = useState(false);
            const [isEditorClosing, setIsEditorClosing] = useState(false);
            const [isConfirmModalClosing, setIsConfirmModalClosing] = useState(false);
            const [isLoggingOut, setIsLoggingOut] = useState(false);
            const [sortConfig, setSortConfig] = useState({ key: 'date', direction: 'desc' });

            // 1. Check Admin & Load Templates
            useEffect(() => {
                if (!user || !db) return;
                
                // Check Admin
                const checkAdmin = async () => {
                    try {
                        const roleSnap = await getDoc(doc(db, 'config', 'roles'));
                        if (roleSnap.exists()) {
                            const admins = roleSnap.data().admins || [];
                            setIsAdmin(admins.includes(user.email));
                        }
                    } catch (e) { console.error("Admin check fail", e); }
                };
                checkAdmin();

                // Load Templates (Fix: Handle empty/missing data gracefully)
                const loadTemplates = async () => {
                    try {
                        const tempSnap = await getDoc(doc(db, 'system_data', 'airline_templates'));
                        if (tempSnap.exists()) {
                            const data = tempSnap.data();
                            if (data && data.templates) {
                                setAirlineTemplates(data.templates);
                            }
                        }
                    } catch (e) { console.error("Template load fail", e); }
                };
                loadTemplates();

                // Load User Data
                const fetchData = async () => {
                    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'mileage_data', 'profile');
                    try {
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) setAirlines(docSnap.data().data || []);
                    } catch (error) { showToast("讀取資料失敗", "error"); } 
                    finally { setIsDataLoaded(true); }
                };
                fetchData();

            }, [user]);

            // Save User Data
            useEffect(() => {
                if (!user || !db || !isDataLoaded) return; 
                const saveData = async () => {
                    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'mileage_data', 'profile');
                    try { await setDoc(docRef, { data: airlines }, { merge: true }); } catch (error) { console.error(error); }
                };
                saveData();
            }, [airlines, user, isDataLoaded]);

            const handleSaveTemplates = async (newTemplates) => {
                setAirlineTemplates(newTemplates);
                setIsAdminModalOpen(false);
                
                // UPDATE LOGIC: Sync changes to existing cards
                // Iterate through existing airlines, if they match a template (by ID prefix), update their definition
                const updatedAirlines = airlines.map(card => {
                   const templateId = card.id.split('_')[0]; // Assuming format 'templateId_timestamp'
                   const matchedTemplate = newTemplates.find(t => t.id === templateId);
                   
                   if (matchedTemplate) {
                       // Merge new template properties but keep user-specific data
                       return {
                           ...card,
                           // Update visual and config properties
                           name: matchedTemplate.name,
                           enName: matchedTemplate.enName,
                           program: matchedTemplate.program,
                           alliance: matchedTemplate.alliance,
                           cardClass: matchedTemplate.cardClass,
                           logoColor: matchedTemplate.logoColor,
                           expiryRule: matchedTemplate.expiryRule,
                           categoryOptions: matchedTemplate.categoryOptions,
                           categoryColors: matchedTemplate.categoryColors,
                           tierOptions: matchedTemplate.tierOptions,
                           // Keep user data: id, memberId, tier (value), records, pending
                       };
                   }
                   return card;
                });
                
                if (JSON.stringify(updatedAirlines) !== JSON.stringify(airlines)) {
                    setAirlines(updatedAirlines);
                }

                try {
                    await setDoc(doc(db, 'system_data', 'airline_templates'), { templates: newTemplates });
                    showToast("模板及現有卡片已更新");
                } catch(e) { showToast("儲存模板失敗", "error"); }
            };

            const stats = useMemo(() => {
                let totalCurrent = 0;
                let totalPending = 0;
                airlines.forEach(a => {
                    const current = a.records.reduce((acc, r) => acc + (parseInt(r.amount) || 0), 0);
                    const pending = a.pending.reduce((acc, i) => acc + (parseInt(i.amount) || 0), 0);
                    totalCurrent += current;
                    totalPending += pending;
                });
                return { totalCurrent, totalPending };
            }, [airlines]);

            const activeAirlineData = useMemo(() => airlines.find(a => a.id === selectedAirlineId), [airlines, selectedAirlineId]);
            const showToast = (msg, type = 'success') => { setToast({ message: msg, type, isVisible: true }); setTimeout(() => setToast(prev => ({ ...prev, isVisible: false })), 3000); };
            const closeConfirm = () => setConfirmDialog({ ...confirmDialog, isOpen: false });
            
            const updateAirline = (id, field, value) => setAirlines(prev => prev.map(a => a.id === id ? { ...a, [field]: value } : a));
            const updateExpiryRule = (id, newRule) => setAirlines(prev => prev.map(a => a.id === id ? { ...a, expiryRule: { ...a.expiryRule, ...newRule } } : a));
            
            const closeDetail = () => { setIsDetailClosing(true); setTimeout(() => { setSelectedAirlineId(null); setIsDetailClosing(false); }, 500); };
            const closeSettings = () => { setIsSettingsClosing(true); setTimeout(() => { setIsSettingsOpen(false); setIsSettingsClosing(false); }, 300); };
            const closeEditor = () => { setIsEditorClosing(true); setTimeout(() => { setEditorState(prev => ({ ...prev, isOpen: false })); setIsEditorClosing(false); }, 300); };
            const closeConfirmModal = () => { setIsConfirmModalClosing(true); setTimeout(() => { setConfirmModal({ ...confirmModal, isOpen: false }); setIsConfirmModalClosing(false); }, 300); };

            const handleAddAirline = (template) => {
                const newAirline = { 
                    ...template, 
                    id: `${template.id}_${Date.now()}`,
                    tier: template.tierOptions[0] 
                }; 
                setAirlines(prev => [...prev, newAirline]);
                setIsAddAirlineOpen(false);
                showToast(`已新增 ${template.name}`);
            };

            const handleDeleteAirline = (id) => {
                setConfirmDialog({
                    isOpen: true, title: '刪除卡片', message: '您確定要刪除這張會籍卡片嗎？',
                    onConfirm: () => {
                        setAirlines(prev => prev.filter(a => a.id !== id));
                        closeConfirm(); closeSettings(); closeDetail();
                        showToast('卡片已刪除', 'success');
                    }
                });
            };

            const handleLogoutClick = () => { setIsLoggingOut(true); setTimeout(() => onLogout(), 500); };

            const saveEditor = (formData) => {
                setAirlines(prev => prev.map(a => {
                    if (a.id !== selectedAirlineId) return a;
                    const listKey = editorState.type === 'record' ? 'records' : 'pending';
                    
                    // Set default category and entryDate if missing for new records
                    let dataToSave = formData;
                    if (listKey === 'records' || listKey === 'pending') { // Ensure category is set for both
                         dataToSave = { 
                            ...formData, 
                            category: formData.category || (a.categoryOptions && a.categoryOptions[0]) || '',
                            entryDate: formData.entryDate || formData.date // Ensure entryDate defaults to date if empty
                        };
                    }

                    const list = a[listKey];
                    const isNew = !list.find(i => i.id === dataToSave.id);
                    let newList = isNew ? [dataToSave, ...list] : list.map(i => i.id === dataToSave.id ? dataToSave : i);
                    return { ...a, [listKey]: newList };
                }));
                closeEditor(); showToast('儲存成功');
            };

            const executeDelete = (id, type) => {
                setAirlines(prev => prev.map(a => {
                    if (a.id !== selectedAirlineId) return a;
                    const listKey = type === 'record' ? 'records' : 'pending';
                    return { ...a, [listKey]: a[listKey].filter(item => item.id !== id) };
                }));
                closeConfirm(); showToast('項目已刪除', 'error');
            };

            const executeConfirm = () => {
                if (!confirmModal.item) return;
                
                // Create a new record with transactionDate as today, and use the selected date as entryDate
                const defaultCategory = (activeAirlineData.categoryOptions && activeAirlineData.categoryOptions[0]) || '';
                
                const confirmedItem = { 
                    id: Date.now(), 
                    name: confirmModal.item.name, 
                    content: confirmModal.item.content || '',
                    amount: confirmModal.item.amount, 
                    date: getTaiwanDate(), // Transaction Date (入帳日, for display/general sorting)
                    entryDate: confirmModal.date, // Entry Date (入檔日期, for expiry calculation)
                    category: confirmModal.item.category || defaultCategory // Preserve pending category if exists
                };
                
                setAirlines(prev => prev.map(a => {
                    if (a.id !== selectedAirlineId) return a;
                    return { ...a, pending: a.pending.filter(p => p.id !== confirmModal.item.id), records: [confirmedItem, ...a.records] };
                }));
                closeConfirmModal(); showToast('哩程已正式入帳');
            };

            const moveCard = (index, direction) => {
                const newIndex = index + direction;
                if (newIndex < 0 || newIndex >= airlines.length) return;
                const newAirlines = [...airlines];
                const [moved] = newAirlines.splice(index, 1);
                newAirlines.splice(newIndex, 0, moved);
                setAirlines(newAirlines);
            };

            const sortedRecords = useMemo(() => {
                if (!activeAirlineData) return [];
                const records = [...activeAirlineData.records];
                return records.sort((a, b) => {
                    let valA, valB;
                    // Sort by the date used for calculation (entryDate or transactionDate)
                    const dateAStr = a.entryDate || a.date;
                    const dateBStr = b.entryDate || b.date;

                    if (sortConfig.key === 'amount') {
                        valA = parseInt(a.amount); valB = parseInt(b.amount);
                    } else if (sortConfig.key === 'expiry') {
                        const dateA = calculateExpiryDate(a.date, a.entryDate, activeAirlineData.expiryRule, activeAirlineData.records);
                        const dateB = calculateExpiryDate(b.date, b.entryDate, activeAirlineData.expiryRule, activeAirlineData.records);
                        valA = dateA ? dateA.getTime() : 0;
                        valB = dateB ? dateB.getTime() : 0;
                    } else if (sortConfig.key === 'name') {
                        valA = a.name.toLowerCase(); valB = b.name.toLowerCase();
                    } else { // default to 'date' (transaction date) or 'entryDate'
                        valA = new Date(dateAStr).getTime(); valB = new Date(dateBStr).getTime();
                    }
                    if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }, [activeAirlineData, sortConfig]);

            const handleSortChange = (key) => {
                setSortConfig(prev => ({
                    key,
                    direction: prev.key === key && prev.direction === 'desc' ? 'asc' : 'desc'
                }));
            };

            const ExpiryRuleOption = ({ type, title, subtitle, icon, isActive, onClick, children }) => (
                React.createElement("div", { onClick: onClick, className: `relative overflow-hidden rounded-xl border-2 transition-all duration-300 cursor-pointer group ${isActive ? 'border-blue-500 bg-blue-50/60 shadow-md' : 'border-slate-100 hover:border-blue-200 hover:bg-slate-50'}` },
                    React.createElement("div", {className: "p-4 flex items-center gap-4"},
                        React.createElement("div", {className: `w-10 h-10 rounded-full flex items-center justify-center transition-colors shrink-0 ${isActive ? 'bg-blue-500 text-white shadow-sm' : 'bg-white text-slate-400 border border-slate-100 group-hover:bg-blue-50 group-hover:text-blue-400'}`}, icon),
                        React.createElement("div", {className: "flex-1 min-w-0"}, React.createElement("div", {className: `text-sm font-bold ${isActive ? 'text-blue-900' : 'text-slate-700'}`}, title), React.createElement("div", {className: "text-[11px] text-slate-500 leading-tight mt-0.5 truncate"}, subtitle)),
                        React.createElement("div", {className: `w-5 h-5 rounded-full border-2 flex items-center justify-center transition-colors shrink-0 ${isActive ? 'border-blue-500 bg-white' : 'border-slate-200 group-hover:border-blue-300'}`}, isActive && React.createElement("div", {className: "w-2.5 h-2.5 rounded-full bg-blue-500"}))
                    ),
                    isActive && children && React.createElement("div", {className: "bg-white/60 backdrop-blur-sm border-t border-blue-100/50 px-4 py-3"}, children)
                )
            );

            return React.createElement("div", {className: `min-h-screen bg-[#f8f9fa] text-slate-800 font-sans relative pb-10 transition-opacity duration-500 ${isLoggingOut ? 'opacity-0' : 'opacity-100 animate-fade-in'}`},
                
                !selectedAirlineId && React.createElement("div", {className: "absolute top-4 right-4 z-20 flex gap-2"},
                    React.createElement("button", {onClick: () => setIsReorderOpen(true), className: "w-10 h-10 bg-white/50 backdrop-blur-md rounded-full shadow-lg text-slate-500 flex items-center justify-center hover:bg-white hover:scale-110 active:scale-95 transition-all duration-300"}, React.createElement(List, {size: 18})),
                    React.createElement("button", {onClick: handleLogoutClick, className: "w-10 h-10 bg-white/50 backdrop-blur-md rounded-full shadow-lg text-slate-500 flex items-center justify-center hover:bg-white hover:scale-110 active:scale-95 transition-all duration-300"}, React.createElement(LogOut, {size: 18}))
                ),

                !selectedAirlineId && React.createElement("div", {className: "max-w-5xl mx-auto px-6 py-8 space-y-8 pt-16 animate-in fade-in slide-in-from-bottom-4 duration-700 pb-32"},
                    React.createElement("div", {className: "bg-white rounded-2xl shadow-sm border border-gray-200 p-6 flex flex-col md:flex-row md:items-center justify-between gap-6 relative overflow-hidden"},
                        React.createElement("div", {className: "absolute top-0 right-0 w-64 h-64 bg-slate-50 rounded-full -mr-16 -mt-16 pointer-events-none"}),
                        React.createElement("div", {className: "flex-1 relative z-10 flex items-center gap-4"},
                            React.createElement("div", {className: "w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-blue-600"}, React.createElement(Wallet, {className: "w-6 h-6"})),
                            React.createElement("div", null,
                                React.createElement("div", {className: "text-xs text-slate-500 font-bold uppercase tracking-wider mb-1"}, "目前持有總計"),
                                React.createElement("div", {className: "text-3xl font-black text-slate-900 leading-none"}, formatNumber(stats.totalCurrent), React.createElement("span", {className: "text-sm font-bold text-slate-400 ml-1"}, "哩"))
                            )
                        ),
                        React.createElement("div", {className: "hidden md:block w-px h-12 bg-gray-100"}),
                        React.createElement("div", {className: "flex-1 relative z-10 flex items-center gap-4"},
                            React.createElement("div", {className: "w-12 h-12 rounded-full bg-orange-50 flex items-center justify-center text-orange-500"}, React.createElement(History, {className: "w-6 h-6"})),
                            React.createElement("div", null,
                                React.createElement("div", {className: "text-xs text-orange-500/80 font-bold uppercase tracking-wider mb-1"}, "待入帳 / 補登中"),
                                React.createElement("div", {className: "text-3xl font-black text-slate-900 leading-none"}, stats.totalPending > 0 ? '+' : '', formatNumber(stats.totalPending), React.createElement("span", {className: "text-sm font-bold text-slate-400 ml-1"}, "哩"))
                            )
                        )
                    ),
                    React.createElement("div", null,
                        React.createElement("div", {className: "flex items-center justify-between mb-6 px-1 mt-4"},
                            React.createElement("h2", {className: "text-xl font-bold text-slate-900 flex items-center gap-2"}, React.createElement(CreditCard, {className: "w-6 h-6 text-slate-400"}), " 會籍卡片"),
                            React.createElement("button", {onClick: () => setIsAddAirlineOpen(true), className: "bg-slate-900 text-white rounded-full p-2 hover:bg-slate-700 shadow-lg active:scale-95 transition-all"}, React.createElement(Plus, {size: 20}))
                        ),
                        airlines.length === 0 ? 
                        React.createElement("div", {className: "flex flex-col items-center justify-center py-20 text-center opacity-50"}, React.createElement(CreditCard, {className: "w-16 h-16 text-gray-300 mb-4"}), React.createElement("p", {className: "text-lg font-bold text-gray-400"}, "尚未新增任何卡片"), React.createElement("button", {onClick: () => setIsAddAirlineOpen(true), className: "mt-4 text-blue-500 font-bold text-sm hover:underline"}, "立即新增")) :
                        React.createElement("div", {className: "grid grid-cols-1 md:grid-cols-2 gap-6 pb-10"}, airlines.map(airline => React.createElement(AirlineCard, {key: airline.id, airline: airline, onClick: () => setSelectedAirlineId(airline.id)})))
                    )
                ),

                selectedAirlineId && activeAirlineData && React.createElement("div", {className: `fixed inset-0 z-50 bg-[#f8f9fa] flex flex-col transition-all duration-500 ${isDetailClosing ? 'opacity-0 pointer-events-none' : 'opacity-100 animate-fade-in'}`},
                    React.createElement("div", {className: "absolute top-0 left-0 w-full z-20 px-5 py-6 flex justify-between items-center pointer-events-none"},
                        React.createElement("button", {onClick: closeDetail, className: "pointer-events-auto w-10 h-10 bg-white/80 backdrop-blur-md rounded-full shadow-lg text-slate-600 flex items-center justify-center hover:bg-white transition-all duration-300 hover:scale-110 active:scale-95"}, React.createElement(ChevronLeft, {size: 20})),
                        React.createElement("button", {onClick: () => { setIsSettingsClosing(false); setIsSettingsOpen(true); }, className: "pointer-events-auto w-10 h-10 bg-white/80 backdrop-blur-md rounded-full shadow-lg text-slate-600 flex items-center justify-center hover:bg-white transition-all duration-300 hover:scale-110 active:scale-95"}, React.createElement(Settings, {size: 20}))
                    ),
                    React.createElement("div", {className: "flex-1 overflow-y-auto p-4 sm:p-6 space-y-6 max-w-3xl mx-auto w-full pt-24 relative pb-32"},
                        React.createElement("div", {className: "rounded-2xl shadow-xl mt-2 animate-in zoom-in-95 duration-500 w-full md:max-w-md mx-auto"}, React.createElement(AirlineCard, {airline: activeAirlineData, onClick: () => {}, isDetail: true})),
                        // ... (Rest of Detail View remains same)
                        React.createElement("div", {className: "animate-in slide-in-from-bottom-8 fade-in duration-700 delay-100"},
                            React.createElement("div", {className: "flex items-center justify-between mb-3 px-2"},
                                React.createElement("h3", {className: "text-sm font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2"}, React.createElement(TrendingUp, {size: 16, className: "text-orange-500"}), " 待入帳"),
                                React.createElement("button", {onClick: () => { setIsEditorClosing(false); setEditorState({ isOpen: true, type: 'pending', data: { id: Date.now(), name: '', content: '', amount: '' } }); }, className: "text-xs font-bold bg-white text-orange-600 px-3 py-1.5 rounded-full shadow-sm border border-orange-100 hover:bg-orange-50 transition-colors flex items-center gap-1 active:scale-95"}, React.createElement(Plus, {size: 14}), " 新增項目")
                            ),
                            React.createElement("div", {className: "bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden divide-y divide-gray-50 transition-all duration-500"},
                                activeAirlineData.pending.length === 0 && React.createElement("div", {className: "p-8 text-center text-gray-300 text-sm"}, "暫無待入帳項目"),
                                activeAirlineData.pending.map(item => React.createElement("div", {key: item.id, className: "p-4 flex items-center justify-between hover:bg-orange-50/30 transition-colors duration-300 group"},
                                    React.createElement("div", null, 
                                        React.createElement("div", {className: "text-base font-bold text-slate-800"}, item.name), 
                                        item.content && React.createElement("div", {className: "text-xs text-slate-500 mt-0.5"}, item.content),
                                        React.createElement("div", {className: `text-sm font-bold mt-0.5 ${item.amount < 0 ? 'text-slate-600' : 'text-orange-500'}`}, formatAmountDisplay(item.amount), React.createElement("span", {className: "text-[10px] text-gray-400 font-normal"}, " Miles"))
                                    ),
                                    React.createElement("div", {className: "flex items-center gap-2"},
                                        React.createElement("button", {onClick: () => { setIsEditorClosing(false); setEditorState({ isOpen: true, type: 'pending', data: item }); }, className: "p-2 text-gray-300 hover:text-blue-500 transition-colors rounded-full hover:bg-blue-50 active:scale-90"}, React.createElement(Edit3, {size: 18})),
                                        React.createElement("button", {onClick: () => setConfirmDialog({ isOpen: true, title: '確認刪除', message: '確定刪除？', onConfirm: () => executeDelete(item.id, 'pending') }), className: "p-2 text-gray-300 hover:text-red-500 transition-colors rounded-full hover:bg-red-50 active:scale-90"}, React.createElement(Trash2, {size: 18})),
                                        React.createElement("div", {className: "w-px h-6 bg-gray-200 mx-1"}),
                                        React.createElement("button", {onClick: () => { setIsConfirmModalClosing(false); setConfirmModal({ isOpen: true, item: item, date: formatDateForInput(new Date()) }); }, className: "flex items-center gap-1.5 bg-slate-800 text-white text-xs font-bold px-3 py-1.5 rounded-lg hover:bg-slate-700 active:scale-95 transition-all shadow-md"}, React.createElement(ArrowDownCircle, {size: 14}), " 入帳")
                                    )
                                ))
                            )
                        ),

                        React.createElement("div", {className: "pb-10 animate-in slide-in-from-bottom-8 fade-in duration-700 delay-200"},
                            React.createElement("div", {className: "flex items-center justify-between mb-3 px-2"},
                                React.createElement("h3", {className: "text-sm font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2"}, React.createElement(History, {size: 16, className: "text-blue-500"}), " 明細紀錄"),
                                React.createElement("button", {onClick: () => { setIsEditorClosing(false); setEditorState({ isOpen: true, type: 'record', data: { id: Date.now(), name: '', content: '', amount: '', date: getTaiwanDate(), entryDate: getTaiwanDate(), category: (activeAirlineData.categoryOptions && activeAirlineData.categoryOptions[0]) || '' } }); }, className: "text-xs font-bold bg-white text-blue-600 px-3 py-1.5 rounded-full shadow-sm border border-blue-100 hover:bg-blue-50 transition-colors flex items-center gap-1 active:scale-95"}, React.createElement(Plus, {size: 14}), " 新增紀錄")
                            ),
                            React.createElement("div", {className: "bg-white/50 backdrop-blur-sm rounded-xl p-2 mb-3 flex justify-between items-center text-xs overflow-x-auto no-scrollbar"},
                                ['date|入帳日', 'expiry|到期日', 'name|名稱', 'amount|哩數'].map(opt => {
                                    const [key, label] = opt.split('|');
                                    const isActive = sortConfig.key === key;
                                    return React.createElement("button", { key: key, onClick: () => handleSortChange(key), className: `flex items-center gap-1 px-3 py-1.5 rounded-lg font-bold transition-all whitespace-nowrap ${isActive ? 'bg-slate-800 text-white shadow-md' : 'text-slate-500 hover:bg-white hover:text-slate-700'}` }, label, isActive && (sortConfig.direction === 'asc' ? React.createElement(ArrowUp, {size: 12}) : React.createElement(ArrowDown, {size: 12})))
                                })
                            ),
                            React.createElement("div", {className: "bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-500"},
                                sortedRecords.length === 0 && React.createElement("div", {className: "p-8 text-center text-gray-300 text-sm"}, "暫無里程紀錄"),
                                sortedRecords.map(item => {
                                    // Pass both transactionDate (item.date) and entryDate (item.entryDate)
                                    const expiryInfo = calculateExpiryDisplay(item.date, item.entryDate, activeAirlineData.expiryRule, activeAirlineData.records, item.amount);
                                    const isNegative = item.amount < 0;
                                    // FIX 3: Defensive access to categoryColors
                                    const categoryColors = activeAirlineData.categoryColors || {};
                                    const categoryColorClass = categoryColors[item.category] || 'bg-gray-100 text-gray-800';
                                    
                                    return React.createElement("div", {key: item.id, className: "p-4 transition-colors duration-300 hover:bg-blue-50/30 group border-b border-gray-50 last:border-0"},
                                        // Row 1: Category | Date | Expiry ....... Miles
                                        React.createElement("div", {className: "flex justify-between items-start mb-2"}, 
                                            React.createElement("div", {className: "flex flex-wrap items-center gap-2 max-w-[75%]"},
                                                // Category Tag
                                                item.category && React.createElement("span", {className: `px-2 py-0.5 rounded-full text-[10px] font-bold shrink-0 truncate ${categoryColorClass}`}, item.category),
                                                // Transaction Date (入帳日)
                                                React.createElement("span", {className: "flex items-center gap-1 text-[10px] text-gray-400 font-medium"}, React.createElement(Calendar, {size: 10}), formatDateForDisplay(item.date)),
                                                // Expiry Date (到期日)
                                                expiryInfo.text && React.createElement("span", {className: `flex items-center gap-1 text-[10px] font-medium ${expiryInfo.color.replace('bg-', 'text-').replace('text-white', 'text-gray-500')}`}, React.createElement(Clock, {size: 10}), expiryInfo.text)
                                            ),
                                            // Miles
                                            React.createElement("div", {className: `text-lg font-mono font-bold ${isNegative ? 'text-slate-600' : 'text-blue-600'} text-right shrink-0 ml-2`}, formatAmountDisplay(item.amount))
                                        ),
                                        
                                        // Row 2: Name (Independent line, multiline support)
                                        React.createElement("div", {className: "text-base font-bold text-slate-800 mb-1 whitespace-pre-wrap break-words leading-snug"}, item.name),

                                        // Row 3: Content (Independent line, multiline support)
                                        item.content && React.createElement("div", {className: "text-sm text-slate-500 mb-2 whitespace-pre-wrap break-words leading-relaxed"}, item.content),

                                        // Row 4: Buttons (Aligned Right)
                                        React.createElement("div", {className: "flex justify-end items-center mt-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 h-6"},
                                            React.createElement("button", {onClick: () => { setIsEditorClosing(false); setEditorState({ isOpen: true, type: 'record', data: item }); }, className: "p-1.5 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-full active:scale-90 transition-transform"}, React.createElement(Edit3, {size: 16})),
                                            React.createElement("button", {onClick: () => setConfirmDialog({ isOpen: true, title: '確認刪除', message: '確定刪除？', onConfirm: () => executeDelete(item.id, 'record') }), className: "p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full active:scale-90 transition-transform"}, React.createElement(Trash2, {size: 16}))
                                        )
                                    );
                                })
                            )
                        )
                    )
                ),

                isSettingsOpen && activeAirlineData && React.createElement("div", {className: `fixed inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300 ${isSettingsClosing ? 'opacity-0' : 'animate-in fade-in opacity-100'}`},
                    React.createElement("div", {className: `bg-white w-full max-w-xs m-4 rounded-3xl p-6 shadow-2xl transition-all duration-300 transform ${isSettingsClosing ? 'scale-95 translate-y-4' : 'scale-100 animate-in zoom-in-95'}`},
                        React.createElement("div", {className: "flex justify-between items-center mb-6 border-b border-gray-100 pb-4"},
                            React.createElement("h3", {className: "text-slate-800 font-bold text-lg flex items-center gap-2"}, React.createElement(Settings, {size: 20, className: "text-slate-400"}), " 設定"),
                            React.createElement("button", {onClick: closeSettings, className: "bg-gray-100 rounded-full p-2 text-gray-500 hover:bg-gray-200 transition-colors"}, React.createElement(X, {size: 18}))
                        ),
                        React.createElement("div", {className: "space-y-6 max-h-[60vh] overflow-y-auto px-1 pb-1 no-scrollbar"},
                            React.createElement("div", {className: "space-y-2"}, React.createElement("label", {className: "text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1"}, React.createElement(Hash, {size: 12}), " 會員卡號"), React.createElement("input", {type: "text", value: activeAirlineData.memberId || '', onChange: (e) => updateAirline(activeAirlineData.id, 'memberId', e.target.value), className: "w-full bg-slate-50 border border-gray-200 rounded-xl px-4 py-2.5 font-mono text-sm text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none uppercase transition-shadow placeholder:font-sans", placeholder: "請輸入會員卡號", autoComplete: "off", name: "member_id_random"})),
                            React.createElement("div", {className: "space-y-2"}, React.createElement("label", {className: "text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1"}, React.createElement(User, {size: 12}), " 會員等級"), React.createElement(CustomSelect, {value: activeAirlineData.tier, options: activeAirlineData.tierOptions, onChange: (val) => updateAirline(activeAirlineData.id, 'tier', val)})),
                            React.createElement("div", {className: "space-y-3 pt-4 border-t border-gray-100"},
                                React.createElement("label", {className: "text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1 mb-2"}, React.createElement(Clock, {size: 12}), " 里程效期規則"),
                                React.createElement(ExpiryRuleOption, { type: 'none', title: '終身有效', subtitle: '里程永不過期', icon: React.createElement(ShieldCheck, {size: 20}), isActive: activeAirlineData.expiryRule.type === 'none', onClick: () => updateExpiryRule(activeAirlineData.id, { type: 'none' }) }),
                                React.createElement(ExpiryRuleOption, { type: 'fixed', title: '固定效期', subtitle: '從入檔日開始計算', icon: React.createElement(Calendar, {size: 20}), isActive: activeAirlineData.expiryRule.type === 'fixed', onClick: () => updateExpiryRule(activeAirlineData.id, { type: 'fixed' }) }, React.createElement("div", {className: "flex items-center gap-2 mt-1"}, React.createElement("div", {className: "flex-1 flex items-center gap-2 bg-white rounded-lg border border-gray-200 p-1 pl-3 shadow-sm"}, React.createElement("span", {className: "text-xs font-bold text-gray-400 shrink-0"}, "時長"), React.createElement("input", { type: "number", value: activeAirlineData.expiryRule.value || 36, onChange: (e) => updateExpiryRule(activeAirlineData.id, { value: e.target.value }), onClick: (e) => e.stopPropagation(), className: "w-full bg-transparent font-bold text-slate-700 outline-none text-right" })), React.createElement("div", {className: "w-16 bg-gray-50 rounded-lg border border-gray-200 p-2 text-center shadow-sm"}, React.createElement("span", {className: "text-xs font-bold text-slate-500"}, "個月")))),
                                React.createElement(ExpiryRuleOption, { type: 'activity', title: '滾動效期', subtitle: '從最後活動日刷新', icon: React.createElement(RefreshCw, {size: 20}), isActive: activeAirlineData.expiryRule.type === 'activity', onClick: () => updateExpiryRule(activeAirlineData.id, { type: 'activity' }) }, React.createElement("div", {className: "flex items-center gap-2 mt-1"}, React.createElement("div", {className: "flex-1 flex items-center gap-2 bg-white rounded-lg border border-gray-200 p-1 pl-3 shadow-sm"}, React.createElement("span", {className: "text-xs font-bold text-gray-400 shrink-0"}, "延長"), React.createElement("input", { type: "number", value: activeAirlineData.expiryRule.value || 18, onChange: (e) => updateExpiryRule(activeAirlineData.id, { value: e.target.value }), onClick: (e) => e.stopPropagation(), className: "w-full bg-transparent font-bold text-slate-700 outline-none text-right" })), React.createElement("div", {className: "w-16 bg-gray-50 rounded-lg border border-gray-200 p-2 text-center shadow-sm"}, React.createElement("span", {className: "text-xs font-bold text-slate-500"}, "個月"))))
                            )
                        ),
                        React.createElement("div", {className: "space-y-3 mt-4 border-t border-gray-100 pt-4"},
                            React.createElement("button", {onClick: () => { showToast('設定已更新'); closeSettings(); }, className: "w-full bg-slate-900 text-white font-bold py-3.5 rounded-2xl shadow-lg hover:bg-slate-800 transition-colors active:scale-95"}, "完成設定"),
                            React.createElement("button", {onClick: () => handleDeleteAirline(activeAirlineData.id), className: "w-full bg-red-50 text-red-500 font-bold py-3.5 rounded-2xl hover:bg-red-100 transition-colors active:scale-95"}, "刪除此卡片")
                        )
                    )
                ),

                // ... (Editor, Confirm Modal same as v1.6)
                React.createElement(AddAirlineModal, { isOpen: isAddAirlineOpen, onClose: () => setIsAddAirlineOpen(false), onSelect: handleAddAirline, templates: airlineTemplates, isAdmin: isAdmin, onOpenAdmin: () => { setIsAddAirlineOpen(false); setIsAdminModalOpen(true); } }),
                React.createElement(ReorderModal, { isOpen: isReorderOpen, onClose: () => setIsReorderOpen(false), items: airlines, onMove: moveCard }),
                React.createElement(AdminTemplateModal, { isOpen: isAdminModalOpen, onClose: () => setIsAdminModalOpen(false), templates: airlineTemplates, onSave: handleSaveTemplates }),

                editorState.isOpen && React.createElement("div", {className: `fixed inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300 ${isEditorClosing ? 'opacity-0' : 'animate-in fade-in opacity-100'}`},
                    React.createElement("div", {className: `bg-white w-full max-w-xs m-4 rounded-3xl p-6 shadow-2xl transition-all duration-300 transform ${isEditorClosing ? 'scale-95 translate-y-4' : 'scale-100 animate-in zoom-in-95'}`},
                        React.createElement("h3", {className: "text-lg font-bold text-slate-800 mb-6 border-b border-gray-100 pb-3"}, editorState.type === 'record' ? '編輯哩程紀錄' : '編輯待入帳項目'),
                        React.createElement("div", {className: "space-y-4"},
                            // FIX 1: Allow showing category selector for both 'record' and 'pending' types
                            (editorState.type === 'record' || editorState.type === 'pending') && activeAirlineData.categoryOptions && activeAirlineData.categoryOptions.length > 0 && 
                            React.createElement("div", null, React.createElement("label", {className: "text-xs font-bold text-slate-400 mb-1 block"}, "類別"), 
                                React.createElement(CustomSelect, {value: editorState.data.category || (activeAirlineData.categoryOptions[0] || ''), options: activeAirlineData.categoryOptions, onChange: val => setEditorState({...editorState, data: {...editorState.data, category: val}})}
                                )
                            ),
                            
                            // Split 'name' into 'name' and 'content' and change to textarea for multiline support
                            React.createElement("div", null, React.createElement("label", {className: "text-xs font-bold text-slate-400 mb-1 block"}, "名稱"), React.createElement("textarea", {rows: 2, value: editorState.data.name, onChange: e => setEditorState({...editorState, data: {...editorState.data, name: e.target.value}}), className: "w-full bg-slate-50 border border-gray-200 rounded-xl px-4 py-3 font-medium text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none transition-shadow resize-none", placeholder: "例如: 台北-東京", autoFocus: true, autoComplete: "off", autoCorrect: "off", spellCheck: "false", name: "record_name_random_string"})),

                            React.createElement("div", null, React.createElement("label", {className: "text-xs font-bold text-slate-400 mb-1 block"}, "內容 (選填)"), React.createElement("textarea", {rows: 3, value: editorState.data.content || '', onChange: e => setEditorState({...editorState, data: {...editorState.data, content: e.target.value}}), className: "w-full bg-slate-50 border border-gray-200 rounded-xl px-4 py-3 font-medium text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none transition-shadow resize-none", placeholder: "例如: JAL JL802\n艙等: 商務艙", autoComplete: "off", autoCorrect: "off", spellCheck: "false", name: "record_content_random_string"})),

                            // Amount remains the same
                            React.createElement("div", null, React.createElement("label", {className: "text-xs font-bold text-slate-400 mb-1 block"}, "哩程數額"), React.createElement("input", {type: "number", value: editorState.data.amount, onChange: e => setEditorState({...editorState, data: {...editorState.data, amount: e.target.value}}), className: "w-full bg-slate-50 border border-gray-200 rounded-xl px-4 py-3 font-mono font-bold text-lg text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none transition-shadow", placeholder: "0", autoComplete: "off", name: "record_amount_random_string"})),

                            editorState.type === 'record' && React.createElement("div", null, React.createElement("label", {className: "text-xs font-bold text-slate-400 mb-1 block"}, "入帳日期 (顯示用)"), React.createElement("input", {type: "date", value: editorState.data.date, onChange: e => setEditorState({...editorState, data: {...editorState.data, date: e.target.value}}), className: "w-full bg-slate-50 border border-gray-200 rounded-xl px-4 py-3 font-medium text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none transition-shadow appearance-none", style: {minHeight:'48px'}})),
                            
                            editorState.type === 'record' && React.createElement("div", null, React.createElement("label", {className: "text-xs font-bold text-slate-400 mb-1 block"}, "入檔日期 (計算效期用)"), React.createElement("input", {type: "date", value: editorState.data.entryDate, onChange: e => setEditorState({...editorState, data: {...editorState.data, entryDate: e.target.value}}), className: "w-full bg-slate-50 border border-gray-200 rounded-xl px-4 py-3 font-medium text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none transition-shadow appearance-none", style: {minHeight:'48px'}}))
                        ),
                        React.createElement("div", {className: "flex gap-3 mt-8"},
                            React.createElement("button", {onClick: closeEditor, className: "flex-1 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-100 transition-colors"}, "取消"),
                            React.createElement("button", {onClick: () => saveEditor(editorState.data), className: "flex-1 py-3 rounded-xl font-bold text-white bg-slate-900 hover:bg-slate-800 shadow-lg shadow-slate-200 transition-all active:scale-95"}, "儲存")
                        )
                    )
                ),
                confirmModal.isOpen && React.createElement("div", {className: `fixed inset-0 z-[80] flex items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300 ${isConfirmModalClosing ? 'opacity-0' : 'animate-in fade-in opacity-100'}`},
                    React.createElement("div", {className: `bg-white w-full max-w-xs m-4 rounded-3xl p-6 shadow-2xl transition-all duration-300 transform ${isConfirmModalClosing ? 'scale-95 translate-y-4' : 'scale-100 animate-in zoom-in-95'}`},
                        React.createElement("h3", {className: "text-lg font-bold text-slate-900 mb-2 border-b border-gray-100 pb-3 flex items-center gap-2"}, React.createElement(CheckCircle2, {size: 20, className: "text-green-500"}), " 確認入帳"),
                        React.createElement("div", {className: "space-y-4 py-2"},
                            React.createElement("div", null, 
                                React.createElement("p", {className: "text-sm font-bold text-slate-800"}, confirmModal.item?.name), 
                                confirmModal.item?.content && React.createElement("p", {className: "text-xs text-slate-500 font-medium mt-0.5"}, confirmModal.item?.content),
                                React.createElement("p", {className: "text-xs text-orange-500 font-bold mt-1"}, formatAmountDisplay(confirmModal.item?.amount), " Miles")
                            ),
                            React.createElement("div", null, React.createElement("label", {className: "text-xs font-bold text-slate-400 mb-1 block flex items-center gap-1"}, React.createElement(CalendarDays, {size: 12}), " 選擇入檔日期 (效期計算基準)"), React.createElement("input", {type: "date", value: confirmModal.date, onChange: e => setConfirmModal({ ...confirmModal, date: e.target.value }), className: "w-full bg-slate-50 border border-gray-200 rounded-xl px-4 py-3 font-medium text-slate-800 focus:ring-2 focus:ring-green-500 outline-none transition-shadow appearance-none", style: {minHeight:'48px'}}))
                        ),
                        React.createElement("div", {className: "flex gap-3 mt-6"},
                            React.createElement("button", {onClick: closeConfirmModal, className: "flex-1 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-100 transition-colors"}, "取消"),
                            React.createElement("button", {onClick: executeConfirm, className: "flex-1 py-3 rounded-xl font-bold text-white bg-green-600 hover:bg-green-700 shadow-lg shadow-green-200 transition-all active:scale-95"}, "確認")
                        )
                    )
                ),

                React.createElement(Toast, {message: toast.message, type: toast.type, isVisible: toast.isVisible}),
                React.createElement(ConfirmDialog, {isOpen: confirmDialog.isOpen, title: confirmDialog.title, message: confirmDialog.message, onConfirm: confirmDialog.onConfirm, onCancel: closeConfirm, confirmText: confirmDialog.confirmText, confirmColorClass: confirmDialog.confirmColorClass})
            );
        };

        const App = () => {
            const [loading, setLoading] = useState(true);
            const [user, setUser] = useState(null);
            useEffect(() => { if (auth) return onAuthStateChanged(auth, (u) => setUser(u)); }, []);
            const handleLogout = async () => { if (auth) await signOut(auth); setUser(null); };
            const handleLogin = () => {};
            if (loading) return React.createElement(SplashScreen, {onFinish: () => setLoading(false)});
            if (!user) return React.createElement(LoginScreen, {onLogin: handleLogin});
            return React.createElement(MainApp, {user: user, onLogout: handleLogout});
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>